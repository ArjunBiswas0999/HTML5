//Copyright (c) 2013 SAP AG, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.components.factsheet.annotation.Mapping");var c;if(typeof c==="undefined"){c=sap.ushell.components.factsheet}if(!c){c={}}if(!c.annotation){c.annotation={}}c.annotation.Mapping={};c.annotation.Mapping.initialized=[];c.annotation.Mapping.parse=function(m,a){var x={},g,b,s,d,f,r,h,n,o,q,t,A,u={},v,w,S={},i,y,z={},B={},C="",D,E,F,G,H,I,J,T,K,L,M,N,O,j,P,Q,R,U,V,W,X,Y,Z,$,_,a1,b1,c1,d1,e1,f1,g1,h1;if(window.ActiveXObject){x={setNameSpace:function(e){e.setProperty("SelectionNamespaces",'xmlns:edmx="http://docs.oasis-open.org/odata/ns/edmx" xmlns:d="http://docs.oasis-open.org/odata/ns/edm"');e.setProperty("SelectionLanguage","XPath");return e},selectNodes:function(e,x,k){return k.selectNodes(x)},nextNode:function(e){return e.nextNode()},getNodeText:function(e){return e.text}}}else{x={setNameSpace:function(e){return e},nsResolver:function(p){var e={"edmx":"http://docs.oasis-open.org/odata/ns/edmx","d":"http://docs.oasis-open.org/odata/ns/edm"};return e[p]||null},selectNodes:function(e,p,k){var l=e.evaluate(p,k,this.nsResolver,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);l.length=l.snapshotLength;return l},nextNode:function(e,k){return e.snapshotItem(k)},getNodeText:function(e){return e.textContent}}}g=function(k){var l;if(window.ActiveXObject){try{l=jQuery.sap.sjax({url:k,xhrFields:{responseType:'msxml-document'}})}catch(e){}}else{l=jQuery.sap.sjax({url:k})}if(l.success){return l.data}};b=function(m){var e={},i1={},j1={},k1=false,i,l1,m1,n1,o1={},j,p1={},q1={},r1=false,s1,l,k,t1,u1,v1,w1,p,x1;for(i=m.dataServices.schema.length-1;i>=0;i-=1){e=m.dataServices.schema[i];if(e.entityType){l1=e.namespace;m1=e.entityType;n1=e.complexType;for(j in m1){o1=m1[j];q1={};if(o1.hasStream&&o1.hasStream==="true"){continue}for(k in o1.property){s1=o1.property[k];if(s1.type.substring(0,l1.length)===l1){for(l in n1){if(n1[l].name===s1.type.substring(l1.length+1)){for(k in n1[l].property){t1=n1[l].property[k];p1[n1[l].name+"/"+t1.name]=t1.type}}}}else{u1=s1.name;v1=s1.type;for(p in s1.extensions){w1=s1.extensions[p];if((w1.name==="display-format")&&(w1.value==="Date")){v1="Edm.Date"}else{r1=true;if(!q1[u1]){q1[u1]={}}if(w1.namespace&&!q1[u1][w1.namespace]){q1[u1][w1.namespace]={}}q1[u1][w1.namespace][w1.name]=w1.value}}p1[u1]=v1}}if(!i1[l1+"."+o1.name]){i1[l1+"."+o1.name]={}}i1[l1+"."+o1.name]=p1;if(r1){if(!j1[l1+"."+o1.name]){k1=true}j1[l1+"."+o1.name]={};j1[l1+"."+o1.name]=q1}}}}if(k1){x1={types:i1,extensions:j1}}else{x1={types:i1}}return x1};s=function(p,e,k,S){var l,i1,j1='';for(l in p){if(p[l]){i1=p[l];if(i1.Value&&i1.Value.Path){j1=d(i1.Value.Path,e,k,S);if(j1){p[l].EdmType=j1}continue}if(i1.Path){j1=d(i1.Path,e,k,S);if(j1){p[l].EdmType=j1}continue}if(i1.Facets){p[l].Facets=s(i1.Facets,e,k,S);continue}if(i1.Data){p[l].Data=s(i1.Data,e,k,S);continue}if(l==="Data"){p.Data=s(i1,e,k,S);continue}if(i1.Value&&i1.Value.Apply){p[l].Value.Apply.Parameters=s(i1.Value.Apply.Parameters,e,k,S);continue}if(i1.Value&&i1.Type&&(i1.Type==="Path")){j1=d(i1.Value,e,k,S);if(j1){p[l].EdmType=j1}}}}return p};d=function(p,e,k,S){var l;if((p.charAt(0)==="@")&&(p.indexOf(S.Alias)===1)){p=p.slice(S.Alias.length+2)}if(p.indexOf("/")>=0){if(e[p.slice(0,p.indexOf("/"))]){k=p.slice(0,p.indexOf("/"));p=p.slice(p.indexOf("/")+1)}}for(l in e[k]){if(p===l){return e[k][l]}}};f=function(e){var k="",l="",i,p={};for(i=0;i<e.attributes.length;i+=1){if((e.attributes[i].name!=="Property")&&(e.attributes[i].name!=="Term")){k=e.attributes[i].name;l=e.attributes[i].value}}if(k.length>0){p[k]=r(l)}return p};h=function(v,e){var k={},l,p,i1,j1,k1,l1;if(e.hasChildNodes()){l=x.selectNodes(v,"./d:String",e);if(l.length>0){p=x.nextNode(l,0);k["String"]=x.getNodeText(p)}else{i1=x.selectNodes(v,"./d:Path",e);if(i1.length>0){j1=x.nextNode(i1,0);k["Path"]=x.getNodeText(j1)}else{k1=x.selectNodes(v,"./d:Apply",e);if(k1.length>0){l1=x.nextNode(k1,0);k["Apply"]=q(v,l1)}}}}return k};n=function(v,e,k){var p={},l,i1,K,j1,k1,l1,m1,n1,o1={},O,P,Y,p1,q1;if(e.hasChildNodes()){l=x.selectNodes(v,"./d:Record | ./d:Collection/d:Record | ./d:Collection/d:If/d:Record",e);if(l.length){i1=0;for(K=0;K<l.length;K+=1){j1=x.nextNode(l,K);k1=o(v,j1,k);if(j1.getAttribute("Type")){k1["RecordType"]=r(j1.getAttribute("Type"))}if(i1===0){if(j1.nextElementSibling||(j1.parentNode.nodeName==="Collection")||(j1.parentNode.nodeName==="If")){p=[];p.push(k1)}else{p=k1}}else{p.push(k1)}i1+=1}}else{l1=x.selectNodes(v,"./d:UrlRef",e);if(l1.length>0){for(K=0;K<l1.length;K+=1){m1=x.nextNode(l1,K);p["UrlRef"]=h(v,m1)}}else{l1=x.selectNodes(v,"./d:Url",e);if(l1.length>0){for(K=0;K<l1.length;K+=1){m1=x.nextNode(l1,K);p["Url"]=h(v,m1)}}else{q1=x.selectNodes(v,"./d:Collection/d:AnnotationPath | ./d:Collection/d:PropertyPath",e);if(q1.length>0){p=[];for(K=0;K<q1.length;K+=1){n1=x.nextNode(q1,K);o1={};o1[n1.nodeName]=n1.textContent;p.push(o1)}}else{p=f(e);O=x.selectNodes(v,"./d:Annotation",e);P={};for(Y=0;Y<O.length;Y+=1){P=x.nextNode(O,Y);if(P.hasChildNodes()===false){p1=r(P.getAttribute("Term"));p[p1]=f(P)}}}}}}}else{p=f(e)}return p};o=function(v,e,k){var p={},P={},O,Y,l,i1,K,j1,k1,l1,m1,n1;O=x.selectNodes(v,"./d:Annotation",e);for(Y=0;Y<O.length;Y+=1){P=x.nextNode(O,Y);if(P.hasChildNodes()===false){l=r(P.getAttribute("Term"));p[l]=f(P)}}i1=x.selectNodes(v,"./d:PropertyValue",e);if(i1.length>0){for(K=0;K<i1.length;K+=1){j1=x.nextNode(i1,K);k1=j1.getAttribute("Property");p[k1]=n(v,j1,k);l1=x.selectNodes(v,"./d:Apply",j1);m1=null;for(n1=0;n1<l1.length;n1+=1){m1=x.nextNode(l1,n1);if(m1){p[k1]={};p[k1]['Apply']=q(v,m1)}}}}else{p=n(v,e,k)}return p};q=function(v,e){var k={},p,l=null,i1=[],i;p=x.selectNodes(v,"./d:*",e);for(i=0;i<p.length;i+=1){l=x.nextNode(p,i);switch(l.nodeName){case"Apply":i1.push({"Type":"Apply","Value":q(v,l)});break;case"LabeledElement":i1.push({"Name":l.getAttribute("Name"),"Value":h(v,l)});break;default:i1.push({"Type":l.nodeName,"Value":x.getNodeText(l)});break}}k['Name']=e.getAttribute('Function');k['Parameters']=i1;return k};t=function(e,p,l){var i1,i,j1,k1,j,k;for(i=m.dataServices.schema.length-1;i>=0;i-=1){i1=m.dataServices.schema[i];if(i1.entityType){j1=i1.namespace+".";k1=i1.entityType;for(k=k1.length-1;k>=0;k-=1){if(j1+k1[k].name===e&&k1[k].navigationProperty){for(j=0;j<k1[k].navigationProperty.length;j+=1){if(k1[k].navigationProperty[j].name===p){return true}}}}}}return false};r=function(e){for(A in z){if(e.indexOf(A+".")>=0){e=e.replace(A+".",z[A]+".");return e}}return e};if(this.initialized[a]){return this.initialized[a]}v=g(a);v=x.setNameSpace(v);w=x.selectNodes(v,"//d:Schema",v);for(i=0;i<w.length;i+=1){y=x.nextNode(w,i);S.Alias=y.getAttribute("Alias");S.Namespace=y.getAttribute("Namespace")}D=x.selectNodes(v,"//edmx:Reference",v);for(i=0;i<D.length;i+=1){E=x.nextNode(D,i);F=x.selectNodes(v,"./edmx:Include",E);if(F&&F.length>0){G=x.nextNode(F,0);if(G.getAttribute("Alias")){z[G.getAttribute("Alias")]=G.getAttribute("Namespace")}else{z[G.getAttribute("Namespace")]=G.getAttribute("Namespace")}}H=x.selectNodes(v,"./edmx:IncludeAnnotations",E);if(H.length>0){for(j=0;j<H.length;j+=1){I=x.nextNode(H,j);if(I.getAttribute("TargetNamespace")){C=I.getAttribute("TargetNamespace");if(!B[C]){B[C]={}}B[C][I.getAttribute("TermNamespace")]=E.getAttribute("Uri")}else{B[I.getAttribute("TermNamespace")]=E.getAttribute("Uri")}}}}if(B){u.annotationReferences=B}u.aliasDefinitions=z;J=x.selectNodes(v,"//d:Term",v);if(J.length>0){T={};for(K=0;K<J.length;K+=1){L=x.nextNode(J,K);M=r(L.getAttribute("Type"));T["@"+S.Alias+"."+L.getAttribute("Name")]=M}u.termDefinitions=T}N=b(m);if(N.extensions){u.propertyExtensions=N.extensions}O=x.selectNodes(v,"//d:Annotations ",v);for(K=0;K<O.length;K+=1){P=x.nextNode(O,K);if(P.hasChildNodes()===false){continue}Q=P.getAttribute("Target");R=Q.split(".")[0];if(R&&z[R]){Q=Q.replace(new RegExp(R,""),z[R])}U=Q;V=null;if(Q.indexOf("/")>0){U=Q.split("/")[0];V=Q.replace(U+"/","")}if(!u[U]){u[U]={}}if(V){if(!u.propertyAnnotations){u.propertyAnnotations={}}if(!u.propertyAnnotations[U]){u.propertyAnnotations[U]={}}u.propertyAnnotations[U][V]={};W=x.selectNodes(v,"./d:Annotation",P);for(Y=0;Y<W.length;Y+=1){X=x.nextNode(W,Y);if(X.hasChildNodes()===false){Z=r(X.getAttribute("Term"));u.propertyAnnotations[U][V][Z]=f(X)}}}else{_=U.replace(z[R],R);W=x.selectNodes(v,"./d:Annotation",P);for($=0;$<W.length;$+=1){X=x.nextNode(W,$);a1=X.getAttribute("Qualifier");b1=r(X.getAttribute("Term"));if(a1){b1+="#"+a1}c1=n(v,X,_);c1=s(c1,N.types,U,S);u[U][b1]=c1}d1=x.selectNodes(v,"//d:Annotations[contains(@Target, '"+_+"')]//d:PropertyValue[contains(@Path, '/')]//@Path",v);for(i=0;i<d1.length;i+=1){e1=x.nextNode(d1,i);f1=e1.value;if(u.propertyAnnotations){if(u.propertyAnnotations[U]){if(u.propertyAnnotations[U][f1]){continue}}}g1=f1.split('/');if(t(U,g1[0],m)){if(!u.expand){u.expand={}}if(!u.expand[U]){u.expand[U]={}}u.expand[U][g1[0]]=g1[0]}}h1=x.selectNodes(v,"//d:Annotations[contains(@Target, '"+_+"')]//d:Path[contains(., '/')]",v);for(i=0;i<h1.length;i+=1){e1=x.nextNode(h1,i);f1=x.getNodeText(e1);if(u.propertyAnnotations[U]){if(u.propertyAnnotations[U][f1]){continue}}if(!u.expand){u.expand={}}if(!u.expand[U]){u.expand[U]={}}g1=f1.split('/');if(t(U,g1[0],m)){if(!u.expand){u.expand={}}if(!u.expand[U]){u.expand[U]={}}u.expand[U][g1[0]]=g1[0]}}}this.initialized[a]=u}return u}}());
